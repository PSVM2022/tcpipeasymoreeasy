1. 트랜스포트 계층의 역할
2. 포트 번호
3. TCP가 정확하게 데이터를 전달하는 방법
4. UDP가 고속으로 데이터를 전달하는 방법
5. netstat 명령으로 네트워크의 상태 확인하기

### 트랜스포트 계층(전송계층)의 역할

---

- 네트워크(인터넷) 계층에서 수신한 데이터를 포트번호 분류에 따라 애플리케이션 계층의 각 애플리케이션으로 전달한다. (애플리케이션 계층에서 받은 데이터에 도착지 정보를 캡슐화해서 네트워크 계층으로 전달한다)
- 트랜스 포트 계층에서는 TCP(신뢰성이 중요할 때) 혹은 UDP(속도가 중요할 때) 프로토콜을 주로 사용한다
    - **TCP - 연결 지향 프로토콜. 데이터 전달에 대한 신뢰성이 있음**
    - **UDP - 데이터그램 지향 프로토콜. 신뢰성을 포기하는 대신 속도가 빠르고 간단한 구조**

### 포트번호 - 서버는 포트번호와 IP 어드레스로 클라이언트를 식별한다.

---

- 포트번호 범위 0~65535 까지 사용한다(IANA 단체에서 규약 관리)
    - 0~1023 서버 프로그램용(웰노운 포트)
        - ex) 20, 21 FTP, 22 SSH, 23 Telnet, 25 SMTP, 80 HTTP, 443 HTTPS
    - 1024~49151 벤더용(레지스터드 포트)
    - 49152~65535번(다이나믹 포트) 클라이언트 프로그램이 사용. 그때그떄 사용포트가 바뀜
- 클라이언트와 서버 간 접속 과정
    1. 클라이언트가 사용할 포트를 할당받는다(다이나믹 포트)
    2. 웹서버의 포트에 연결요청한다(웹서버 80 or 443)
    3. 웹 서버가 접속을 허용하면 통신가능한 상태가 된다.
    4. 통신이 종료되면 클라이언트의 포트를 반납한다

### TCP

---

- 웹이나 이메일, FTP 등과 같이 정확한 데이터 전달이 필요한 통신에 사용합니다
- **TCP는 패킷 사이의 순서를 보장합니다**. **연결 지향 프로토콜인 3-way handshake**를 사용해서 연결하고 신뢰성을 구축하고, 수신여부를 확인합니다. **가상회선 패킷 교환방식**을 사용합니다.
- 데이터 전송에 신뢰성을 더하기 위해
    1. 데이터를 세그먼트 단위로 나눈다. 
        - 세그먼트 = TCP 헤더 + 데이터 ↔  패킷 = IP헤더 + TCP헤더 + 데이터
    2. 전송 속도를 조절한다. (흐름제어, 혼잡제어)
        - 송신측의 전송속도보다 수신자의 처리속도가 느릴 때의 흐름제어 방식 2가지 (수신자가 패킷을 너무 많이 받지 않도록 조절하는 방법 - 수신자가 송신자에게 자신의 상태를 피드백한다)
            - Stop and wait - 매번 전송한 패킷에 대해서 확인 응답을 받아야 그 다음
            - **Sliding Window(Go Back N ARQ) - 수신 측에서 설정한 윈도우 크기만큼 송신측에서 확인 응답 없이 세그먼트를 전송할 수 있게 해서 데이터 흐름을 동적으로 조절하는 제어기법**
        - 네트워크 상의 패킷 수가 너무 많아 라우터에 데이터가 몰리는 혼잡현상을 방지하는 혼잡제어 방식
        (다양한 방식이 있음)
            - **Slow Start** - 느린 시작 방식. 패킷을 하나씩 보내면서 시작한다. 문제없이 도착했다고 ACK 패킷이 올 때마다 window size를 2배씩 늘린다. 한번 혼잡 현상이 일어나면 다시 절반으로 줄이고, 혼잡현상 기준까지 완만하게 1씩 증가시킨다.
    3. 데이터가 전달되지 않았다면 재전송을 한다. 
- **TCP 통신에서 사용하는 세그먼트 포맷**
    
    ![[http://www.ktword.co.kr/test/view/view.php?m_temp1=1889](http://www.ktword.co.kr/test/view/view.php?m_temp1=1889)](/image/1889_1.jpeg)
    
    [http://www.ktword.co.kr/test/view/view.php?m_temp1=1889](http://www.ktword.co.kr/test/view/view.php?m_temp1=1889)
    
    - 컨트롤 비트 - 현재의 통신상태를 표현하는 플래그입니다. 이 정보를 전달해서 TCP 통신을 제어합니다.
        - CWR - 송신 측에서 통신 경로가 혼잡해 전송량을 줄여달라고 알린다
        - ECE - 수신 측에서 통신경로가 혼잡해서 수신할 수 없을 수도 있다고 알린다
        - URG - 전송 데이터 중에 긴급히 전달해야될 데이터가 있을 때 사용
        - **ACK - 이전 동작을 확인했다고 알려준다. SYN 세그먼트 이후 모든 세그먼트는 ACK 1로 셋팅.**
        - PSH - 수신 데이터를 즉시 애플리케이션계층에 전달하라고 알린다. 버퍼가 채워지지 않아도 전달.
        - RST - 이상현상으로 접속이 강제 중단 되었다고 알림
        - **SYN - 접속을 시작할 때 ON. 세션 설정시 사용한다. 초기에 임의의 시퀸스 넘버를 보낸다.**
        - **FIN - 데이터 송신이 완료되서 세션을 종료시키는데 사용한다.**
- TCP 통신 시작부터 종료까지의 흐름
    - 커넥션 연결 시에 **3-way handshake 과정**을 거쳐 데이터를 전송할 수 있는 상태가 된다.
    - 커넥션 연결 시에 송수신 측은 일련번호와 최대 세그먼트크기(MSS)를 정한다.
    - 커넥션을 맺는 과정에서 일련번호sequence number는 1씩 증가한다.
    - ~~데이터 전송시에는 확인응답번호acnowledgement number + 1에 전송한 데이터의 바이트 수도 더하면서 전송한다.~~
    - 송신 측에서 일정시간이 지난 후에도 수신측 응답이 오지 않으면 송신 실패로 간주하고 최근에 정상적으로 응답받은 기점 후부터 데이터를 **재전송**한다
    - 응답을 기다리지 않고 연속해서 데이터를 몰아서 보내는 방식도 있다
    - 수신 측에서 수신한 데이터를 처리하기 전에 일시보관하는 버퍼영역을 가지고 있는데, TCP 헤더의 윈도우 사이즈에 버퍼 크기를 설정해서 송신 측에 통보해서 어느 정도 크기까지 한번에 받을 수 있는지 알려주고, 이후로도 어느 정도까지 받을 수 있는지 수시로 알려준다. **(흐름제어 flow control)**
    - 네트워크 경로가 혼잡하면 혼잡 플래그를 On 해서 송수신 측이 서로 통신 속도를 조절한다
    - 버퍼가 가득 차면 윈도우 사이즈가 0으로 설정되고 데이터 전송이 멈춥니다. 다시 전송을 재개하기 위해 송신측은 **탐색 패킷(윈도우 프로브 패킷)**을 보내서 수신측으로부터 현재 윈도우 사이즈를 확인해서 전송을 재개합니다.

### TCP 통신의 3-way handshake(연결과정), 4-way handshake(연결 해제과정)

---

- TCP 통신에서 세션 연결 시에 신뢰성을 확보하기 이해 **3-way handshake** 작업을 수행합니다. **(연결과정)**
    
    ![Screen Shot 2022-09-25 at 5.20.10 PM.png](/image/img2.png)
    
    - **SYN**(cronization) - 연결요청 플래그, **ACK**(nowledgement) - 응답플래그
    - ISN(initial sequence Numbers) - 초기 네트워크 연결 시에 할당된 32비트 고유 시퀸스 번호. 새로운 TCP 연결의 첫번 째 패킷에 할당된다.
    - 연결과정 3단계
        1. **SYN** - 클라이언트가 서버에 ISN을 담아서 SYN을 보냅니다.
        2. **SYN + ACK** - 서버는 SYN을 수신하고 서버의 ISN을 보내면서 승인번호로 클라이언트의 ISN + 1 값을 보냅니다
        3. **ACK** - 클라이언트는 서버의 ISN + 1 값인 승인번호를 담아서 다시 ACK를 서버에 보냅니다. 이 과정을 통해 신뢰성이 구축되면서 데이터 전송을 시작합니다. 
    - 3-way handshake 과정을 거치는 TCP를 신뢰성이 있는 계층이라 하고, UDP는 이 과정을 거치지 않기 때문에 신뢰성이 없는 계층이라고 합니다.
- TCP 통신 연결 해제 시에 **4-way handshake** 작업을 수행합니다**. (연결 해제과정)**
    
    ![Screen Shot 2022-09-25 at 5.26.33 PM.png](/image/img3.png)
    
    - 연결 해제과정 4단계
        1. **FIN** - 클라이언트가 연결을 닫으려고 할 때 FIN 세그먼트를 보냅니다. 이후 클라이언트는 FIN_WATE_1 상태에서 서버응답을 기다립니다.
        2. **ACK** - 서버는 클라이언트에 ACK 승인 세그먼트를 보냅니다. 이후 서버는 CLOSE_WAIT상태로 들어갑니다. 
        클라이언트가 세그먼트를 받으면 FIN_WAIT_2 상태에 들어갑니다. 
        3. **FIN** - 서버는 ACK 보내고 일정 시간 이후에 클라이언트에 FIN 세그먼트를 보냅니다. 
        4. **ACK** - 클라이언트는 FIN을 받으면 TIME_WAIT 상태가 되고 서버에 ACK를 보내서 서버는 CLOSED 상태가 됩니다. 이후 어느정도 시간 대기 이후에 연결이 닫히고, 클라이언트, 서버의 모든 자원 연결이 해제됩니다. 
    - **클라이언트 측의 TIME_WAIT 상태**: 소켓이 바로 소멸하지 않고 일정 시간 유지되는 상태를 뜻합니다. 지연 패킷이 있을지도 모르는 문제를 해결하기 위해 대기시간을 두었습니다. 패킷이 뒤늦게 온 것을 처리하지 못하면 데이터 무결성 문제가 발생합니다. **서버는 CLOSE_WAIT**
        - OS마다 이 시간이 다른데 리눅스 CentOS나 우분투는 60초 설정이 기본값이고, 윈도우는 4분으로 되어있습니다.
        - data integrity 데이터 무결성. 데이터의 정확성 일관성을 유지하고 보증하는 것입니다.

### UDP

---

- **UDP는 패킷 순서를 보장하지 않고** 단순히 **데이터만 전송하는 데이터그램 패킷 교환방식**을 사용합니다.
    - 가상회선 패킷 교환 방식 - 각 패킷에는 가상회선 식별자가 포함되서 모든 패킷을 전송하면 가상회선이 해제되고, 패킷들이 전송된 순서대로 도착하는 방식입니다.
    - 데이터그램 패킷 교환 방식 - 패킷이 독립적으로 이동하면서 최적의 경로를 선택해서 가는데, 이 때문에 도착한 순서가 다를 수 있는 방식입니다.
- 데이터 손실이 일어날 수 있기 떄문에 VoIP나 동영상 스트리밍 같이 패킷 손실이 있어도 큰 문제가 없이 빠른 전송이 필요한 서비스에서 이용합니다.
- UDP 통신에서 사용하는 데이터그램 포맷 ↔  TCP의 패킷에 해당
    
    ![UDP 세그먼트 포맷. 필드가 4개뿐이다. 32bit 8바이트](/image/img4.png)
    
    UDP 세그먼트 포맷. 필드가 4개뿐이다. 32bit 8바이트
    
- UDP에서는 1대다 전송인 브로드캐스트, 멀티캐스트를 지원한다.
    - 브로드캐스트- 카톡방 모두에게 메세지 전달하는 것은 각각에게 모두 UDP connection이 되는 것임. 자신의 호스트가 속해있는 네트워크 안의 모든 수신자에게 패킷을 전송한다.
- UDP 통신에서 지원하지 않는 흐름제어, 혼잡제어 기능을 애플리케이션 계층에서 구현해서 부족한 신뢰성을 보완하기도 한다.
    - 데이터를 전송하는 과정에서 발생하는 오류의 종류 3가지
        1. **패킷의 잘못된 순서**(TCP는 패킷의 시퀸스를 보장합니다)
        2. **패킷의 손실**(TCP는 재전송기능이 있습니다)
        3. **패킷 내부의 손상된 데이터**(TCP, UDP는 체크섬 기반으로 오류검사가 가능합니다)
            - 체크섬 - 헤더, 패킷내용, IP를 기반으로 패킷 손상을 검사합니다.
            
            ![Screen Shot 2022-09-25 at 5.01.43 PM.png](/image/checksum.png)
            
        

### TCP - UDP 통신의 차이점

---

- 대표적인 차이 - 순서보장여부, 패킷 전송 방식,
    - **TCP는 패킷 사이의 순서를 보장합니다**. **연결 지향 프로토콜인 3-way handshake**를 사용해서 연결하고 신뢰성을 구축하고, 수신여부를 확인합니다. **가상회선 패킷 교환방식**을 사용합니다.
    - **UDP는 패킷 순서를 보장하지 않고** 단순히 **데이터만 주는 데이터그램 패킷 교환방식**을 사용합니다.
        - 가상회선 패킷 교환 방식 - 각 패킷에는 가상회선 식별자가 포함되서 모든 패킷을 전송하면 가상회선이 해제되고, 패킷들이 전송된 순서대로 도착하는 방식입니다.
        - 데이터그램 패킷 교환 방식 - 패킷이 독립적으로 이동하면서 최적의 경로를 선택해서 가는데, 이 때문에 도착한 순서가 다를 수 있는 방식입니다.
    - 데이터를 전송하는데 발생하는 오류의 종류 대표적인 3가지
        - **패킷의 잘못된 순서**(TCP는 패킷의 시퀸스를 보장합니다)
        - **패킷의 손실**(TCP는 재전송기능이 있습니다)
        - **패킷 내부의 손상된 데이터**(TCP, UDP는 체크섬 기반으로 오류검사가 가능합니다)
            - 체크섬 - 헤더, 패킷내용, IP를 기반으로 패킷 손상을 검사합니다.
                
                ![Screen Shot 2022-09-25 at 5.01.43 PM.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/e1aecfa3-3711-483a-930c-b92dbe527b09/Screen_Shot_2022-09-25_at_5.01.43_PM.png)
                
- 총정리
    
    ![Screen Shot 2022-09-25 at 5.05.56 PM.png](/image/tcpudpcompare.png)
    
    - TCP는 데이터 전송을 위해 연결을 열고 선택된 가상회선으로 패킷을 순서대로 보내고, 전송이 끝나면 연결을 닫습니다.
    - UDP는 연결에 대한 오버헤드 없이 최적의 경로로 패킷을 보낼 수 있기 때문에, 브로드캐스트, 멀티캐스트 유형의 네트워크 전송에 사용하면 효율적입니다. ↔ 유니캐스트(1대1 전송). TCP는 브로드캐스팅을 지원하지 않습니다.
    - TCP 패킷의 헤더 길이는 가변길이입니다
    - UDP는 8바이트의 고정 길이입니다.
    - **TCP 통신은 SYN, ACK 같은 1비트 크기 제어 플래그를 사용해서**
        - **흐름제어와 혼잡제어 기능을 제공합니다**
        - 체크섬이 있기 때문에 신뢰성은 TCP, UDP 통신 둘 다 보장합니다.
        - ack num vs checksum